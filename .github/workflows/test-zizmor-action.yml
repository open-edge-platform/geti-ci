# Integration tests for Zizmor composite action
# Tests various configurations and scenarios to ensure the action works correctly

name: Test Zizmor Action

on:
  pull_request:
    paths:
      - "actions/zizmor/**"
      - ".github/workflows/test-zizmor-action.yml"
  push:
    branches:
      - main
    paths:
      - "actions/zizmor/**"
      - ".github/workflows/test-zizmor-action.yml"
  workflow_dispatch:

permissions: {}

jobs:
  # Test 1: Validates basic functionality with default settings
  zizmor-test:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Run Zizmor - all scope with defaults
        id: zizmor-all
        uses: ./actions/zizmor
        with:
          upload-sarif: false
          scan-scope: all
          fail-on-findings: false

      - name: Verify scan executed
        shell: bash
        env:
          SCAN_RESULT: ${{ steps.zizmor-all.outputs.scan_result }}
        run: |
          if [[ -z "$SCAN_RESULT" ]]; then
            echo "Error: scan_result output is empty"
            exit 1
          fi
          echo "Scan completed with exit code: $SCAN_RESULT"

  # Summary job - provides single point of success/failure
  # We may add more test jobs in the future
  zizmor-test-summary:
    runs-on: ubuntu-latest
    needs:
      - zizmor-test
    if: always()
    steps:
      - name: Check test results
        shell: bash
        env:
          TEST_RESULT: ${{ needs.zizmor-test.result }}
        run: |
          if [[ "$TEST_RESULT" != "success" ]]; then
            echo "❌ Test failed"
            exit 1
          fi

          echo "✅ All Zizmor action tests passed successfully!"
