# Integration tests for Collect SBOM Library composite action

name: Test Collect SBOM Library Action

on:
  pull_request:
    paths:
      - "actions/collect-sbom-library/**"
      - ".github/workflows/test-collect-sbom-library-action.yml"
  push:
    branches:
      - main
    paths:
      - "actions/collect-sbom-library/**"
      - ".github/workflows/test-collect-sbom-library-action.yml"
  workflow_dispatch:

permissions: {}

jobs:
  # Test 1: Validates basic functionality with no extras
  basic-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - &checkout
        name: Checkout Code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - &create-pyproject
        name: Create test pyproject.toml
        shell: bash
        run: |
          mkdir -p test-project/test_project
          cat > test-project/pyproject.toml << 'EOF'
          [project]
          name = "test-project"
          version = "0.1.0"
          description = "Test project for SBOM collection"
          requires-python = ">=3.10"
          dependencies = [
              "requests>=2.28.0",
          ]

          [project.optional-dependencies]
          dev = ["pytest>=7.0.0"]
          test = ["coverage>=7.0.0"]

          [build-system]
          requires = ["hatchling"]
          build-backend = "hatchling.build"
          EOF
          echo "# Test project" > test-project/test_project/__init__.py

      - &install-uv
        name: Install uv
        uses: astral-sh/setup-uv@803947b9bd8e9f986429fa0c5a41c367cd732b41 # v7.2.1
        with:
          version: "0.9.29"

      - &generate-lockfile
        name: Generate lockfile
        shell: bash
        working-directory: test-project
        run: uv lock

      - name: Run collect-sbom-library action
        uses: ./actions/collect-sbom-library
        with:
          path: test-project
          extras: "dev"
          artifact-name: test-basic-licenses

      - name: Verify CSV was created
        shell: bash
        run: |
          if [[ ! -f "test-project/licenses-library.csv" ]]; then
            echo "❌ Error: licenses-library.csv was not created"
            exit 1
          fi
          echo "✅ licenses-library.csv created successfully"
          echo "Content preview:"
          head -10 test-project/licenses-library.csv

  # Test 2: Validates functionality with valid extras
  extras-test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    permissions:
      contents: read
    steps:
      - *checkout

      - *create-pyproject

      - *install-uv

      - *generate-lockfile

      - name: Run collect-sbom-library with extras
        uses: ./actions/collect-sbom-library
        with:
          path: test-project
          extras: "dev,test"
          artifact-name: test-licenses

      - name: Verify CSV was created with extras
        shell: bash
        run: |
          if [[ ! -f "test-project/licenses-library.csv" ]]; then
            echo "❌ Error: licenses-library.csv was not created"
            exit 1
          fi
          echo "✅ licenses-library.csv created successfully with extras"
          echo "Content preview:"
          head -10 test-project/licenses-library.csv

  # Test 3: Validates that malicious extras input is rejected (injection with --index-url)
  injection-test-index-url:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - *checkout

      - *create-pyproject

      - name: Run collect-sbom-library with malicious input (should fail)
        id: injection-test
        continue-on-error: true
        uses: ./actions/collect-sbom-library
        with:
          path: test-project-injection
          extras: "dev --index-url https://malicious.example.com"
          artifact-name: test-injection-licenses

      - name: Verify injection was blocked
        shell: bash
        env:
          STEP_OUTCOME: ${{ steps.injection-test.outcome }}
        run: |
          if [[ "$STEP_OUTCOME" == "success" ]]; then
            echo "❌ Error: Injection attack was not blocked!"
            exit 1
          fi
          echo "✅ Injection attempt with --index-url was correctly blocked"

  # Test 4: Validates that extras starting with dash are rejected
  injection-test-dash-prefix:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - *checkout

      - *create-pyproject

      - name: Run collect-sbom-library with dash-prefixed extra (should fail)
        id: dash-test
        continue-on-error: true
        uses: ./actions/collect-sbom-library
        with:
          path: test-project-dash
          extras: "--extra,dev"
          artifact-name: test-dash-licenses

      - name: Verify dash-prefix was blocked
        shell: bash
        env:
          STEP_OUTCOME: ${{ steps.dash-test.outcome }}
        run: |
          if [[ "$STEP_OUTCOME" == "success" ]]; then
            echo "❌ Error: Dash-prefixed extra was not blocked!"
            exit 1
          fi
          echo "✅ Dash-prefixed extra was correctly blocked"

  # Test 5: Validates that special characters are rejected
  injection-test-special-chars:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: read
    steps:
      - *checkout

      - *create-pyproject

      - name: Run collect-sbom-library with special characters (should fail)
        id: special-test
        continue-on-error: true
        uses: ./actions/collect-sbom-library
        with:
          path: test-project-special
          extras: "dev;rm -rf /"
          artifact-name: test-special-licenses

      - name: Verify special characters were blocked
        shell: bash
        env:
          STEP_OUTCOME: ${{ steps.special-test.outcome }}
        run: |
          if [[ "$STEP_OUTCOME" == "success" ]]; then
            echo "❌ Error: Special characters were not blocked!"
            exit 1
          fi
          echo "✅ Special characters were correctly blocked"
